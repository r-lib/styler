#!/usr/bin/env Rscript


'Run lintr on a package.
Usage:
  lintr [--warn_only] <files>...
Options:
  --warn_only  Print lint warnings instead of blocking the commit. Should be
               used with `verbose: true` in `.pre-commit-config.yaml`.
' -> doc

arguments <- docopt::docopt(doc)

if (git2r::in_repository()) {
  git_status <- git2r::status(staged = FALSE)
  if (any(unlist(git_status) == ".lintr")) {
    stop("Unstaged changes to .lintr file. Stage the .lintr file or discard ",
         "the changes to it. ", call. = FALSE)
  }
}

for (path in arguments$files) {
  lints <- lintr::lint(path)
  if (length(lints) > 0 && arguments$warn_only) {
    cat("Warning: File `", path, "` is not lint free\n", sep = "")
    print(lints)
  } else if (length(lints) > 0) {
    stop(
      "File ", path, " is not lint free\n",
      "Run lintr::lint('", path, "') to check the lintr output.",
      call. = FALSE
    )
  }
}

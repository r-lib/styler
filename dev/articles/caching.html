<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="styler">
<title>Caching • styler</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Caching">
<meta property="og:description" content="styler">
<meta property="og:image" content="https://styler.r-lib.org/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">styler</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.10.3.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/styler.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/detect-alignment.html">Alignment detection</a>
    <a class="dropdown-item" href="../articles/strict.html">The effect of `strict = FALSE`</a>
    <a class="dropdown-item" href="../articles/third-party-integrations.html">Third-party integrations</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Developers</h6>
    <a class="dropdown-item" href="../articles/remove_rules.html">Remove rules</a>
    <a class="dropdown-item" href="../articles/customizing_styler.html">Customizing styler</a>
    <a class="dropdown-item" href="../articles/distribute_custom_style_guides.html">Distribute custom style guides</a>
    <a class="dropdown-item" href="../articles/caching.html">Caching</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-news">News</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-news">
    <h6 class="dropdown-header" data-toc-skip>Releases</h6>
    <a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2017/12/styler-1.0.0/">Version 1.0.0</a>
    <a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/11/styler-1-2-0/">Version 1.2.0</a>
    <a class="external-link dropdown-item" href="https://lorenzwalthert.netlify.com/post/styler-1-3-0/">Version 1.3.0</a>
    <a class="external-link dropdown-item" href="https://lorenzwalthert.netlify.app/post/styler-1-4-0/">Version 1.4.0</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../news/index.html">Changelog</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/styler/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Caching</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/styler/blob/HEAD/vignettes/caching.Rmd" class="external-link"><code>vignettes/caching.Rmd</code></a></small>
      <div class="d-none name"><code>caching.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/styler" class="external-link">styler</a></span><span class="op">)</span></span></code></pre></div>
<p>This is a developer vignette to explain how caching works and what we
learned on the way.</p>
<p>The main caching features were implemented in the following two pull
requests:</p>
<ul>
<li><p>#538: Implemented simple caching and utilities for managing
caches. Input text is styled as a whole and added to the cache
afterwards. This makes most sense given that the very same expression
will probably never be passed to styler, unless it is already compliant
with the style guide. Apart from the (negligible) inode, caching text
has a memory cost of 0. Speed boosts only result if the whole text
passed to styler is compliant to the style guide in use. Changing one
line in a file with hundreds of lines means each line will be styled
again. This is a major drawback and makes the cache only useful for a
use with a pre-commit framework (the initial motivation) or when
functions like <code><a href="../reference/style_pkg.html">style_pkg()</a></code> are run often and most files
were not changed.</p></li>
<li><p>#578: Adds a second layer of caching by caching top-level
expressions individually. This will bring speed boosts to the situation
where very little is changed but there are many top-level expressions.
Hence, changing one line in a big file will invalidate the cache for the
expression the line is part of, i.e. when changing
<code>x &lt;- 2</code> to <code>x = 2</code> below, styler will have to
restyle the function definition, but not <code>another(call)</code> and
all other expressions that were not changed.</p></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># a comment</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># &lt;- change this line</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">another</span><span class="op">(</span><span class="va">call</span><span class="op">)</span></span></code></pre></div>
<p>While #538 also required a lot of thought, this is not necessarily
visible in the diff. The main challenge was to figure out how the
caching should work conceptually and where we best insert the
functionality as well as how to make caching work for edge cases like
trailing blank lines etc. For details on the conceptual side and
requirements, see #538.</p>
<p>In comparison, the diff in #578 is much larger. We can walk through
the main changes introduced here:</p>
<ul>
<li><p>Each nest gained a column <em>is_cached</em> to indicate if an
expression is cached. It’s only ever set for the top-level nest, but set
to <code>NA</code> for all other nests. Also, comments are not cached
because they are essentially top level terminals which are very cheap to
style (also because hardly any rule concerns them) and because each
comment is a top-level expression, simply styling them is cheaper than
checking for each of them if it is in the cache.</p></li>
<li><p>Each nest also gained a column <em>block</em> to denote the block
to which it belongs for styling. Running each top-level expression
through <code><a href="../reference/parse_transform_serialize_r.html">parse_transform_serialize_r()</a></code> separately is
relatively expensive. We prefer to put multiple top-level expressions
into a block and process the block. This is done with
<code><a href="../reference/parse_transform_serialize_r_block.html">parse_transform_serialize_r_block()</a></code>. Note that before we
implemented this PR, all top-level expressions were sent through
<code><a href="../reference/parse_transform_serialize_r.html">parse_transform_serialize_r()</a></code> as one block. Leaving out
some exceptions in this explanation, we always put uncached top-level
expressions in a block and cached top-level expressions into a block and
then style the uncached ones.</p></li>
<li><p>Apart from the actual styling, a very costly part of formatting
code with styler is to compute the nested parse data with
<code><a href="../reference/compute_parse_data_nested.html">compute_parse_data_nested()</a></code>. When caching top-level
expressions, it is evident that building up the nested structure for
cached code is unnecessary because we don’t actually style it, but
simply return <code>text</code>. For this reason, we introduce the
concept of a shallow nest. It can only occur at the top level. For the
top-level expressions we know that they are cached, we remove all
children before building up the nested parse table and let them act as
<code>terminals</code> and will later simply return their
<code>text</code>. Hence, in the nested parse table, no cached
expressions have children.</p></li>
<li><p>Because we now style blocks of expressions and we want to
preserve the line breaks between them, we need to keep track of all
blank lines between expressions, which was not necessary previously
because all expressions were in a block and the blank lines separating
them were stored in <code>newlines</code> and <code>lag_newlines</code>
except for all blank lines before the first expression.</p></li>
<li><p>Because we wanted to cache by expression, but process by block of
expression, we needed to decompose the block into individual expressions
and add them to the cache once we obtained the final text. We could
probably also have added expressions to the cache before we put the text
together, but the problem is that at some point we turn the nested
structure into a flat structure and as this must happen with a
<code><a href="../reference/visit.html">post_visit()</a></code> approach, we’d have to implement a complicated
routine to check if we are now about to put together all top-level
expressions and then if yes write them to the cache. A simple (but maybe
not so elegant) parsing of the output as implemented in
<code><a href="../reference/cache_by_expression.html">cache_by_expression()</a></code> seemed reasonable in terms of
limiting complexity and keeping efficiency.</p></li>
</ul>
<p>For more detailed explanation and documentation, please consult the
help files of the internals.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://krlmlr.info" class="external-link">Kirill Müller</a>, <a href="https://lorenzwalthert.com" class="external-link">Lorenz Walthert</a>, <a href="https://sites.google.com/site/indrajeetspatilmorality/" class="external-link">Indrajeet Patil</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>

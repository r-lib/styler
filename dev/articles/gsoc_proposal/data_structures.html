<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Structures • styler</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><!-- docsearch --><script src="../../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Data Structures">
<meta property="og:description" content="styler">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">styler</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.6.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../articles/styler.html">Get started</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/detect-alignment.html">Alignment detection</a>
    </li>
    <li>
      <a href="../../articles/strict.html">The effect of `strict = FALSE`</a>
    </li>
    <li>
      <a href="../../articles/third-party-integrations.html">Third-party integrations</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Developers</li>
    <li>
      <a href="../../articles/remove_rules.html">Remove rules</a>
    </li>
    <li>
      <a href="../../articles/customizing_styler.html">Customizing styler</a>
    </li>
    <li>
      <a href="../../articles/distribute_custom_style_guides.html">Distribute custom style guides</a>
    </li>
    <li>
      <a href="../../articles/caching.html">Caching</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Releases</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2017/12/styler-1.0.0/">Version 1.0.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/blog/2019/11/styler-1-2-0/">Version 1.2.0</a>
    </li>
    <li>
      <a href="https://lorenzwalthert.netlify.com/post/styler-1-3-0/">Version 1.3.0</a>
    </li>
    <li>
      <a href="https://lorenzwalthert.netlify.app/post/styler-1-4-0/">Version 1.4.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/styler/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="data_structures_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Data Structures</h1>
                        <h4 class="author">Lorenz Walthert</h4>
            
            <h4 class="date">2021-10-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/styler/blob/master/vignettes/gsoc_proposal/data_structures.Rmd"><code>vignettes/gsoc_proposal/data_structures.Rmd</code></a></small>
      <div class="hidden name"><code>data_structures.Rmd</code></div>

    </div>

    
    
<blockquote>
<p>This vignette is partly outdated since nested structure was implemented completely.</p>
</blockquote>
<p>This vignette illustrates how the core of <code>styler</code> currently<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> works, i.e. how rules are applied to a parse table and how limitations of this approach can be overcome with a refined approach.</p>
<div id="status-quo---the-flat-approach" class="section level2">
<h2 class="hasAnchor">
<a href="#status-quo---the-flat-approach" class="anchor"></a>Status quo - the flat approach</h2>
<p>Roughly speaking, a string containing code to be formatted is parsed with <code>parse</code> and the output is passed to <code>getParseData</code> in order to obtain a parse table with detailed information about every token. For a simple example string “<code>a &lt;- function(x) { if(x &gt; 1) { 1+1 } else {x} }</code>” to be formatted, the parse table on which <code>styler</code> performs the manipulations looks similar to the one presented below.</p>
<pre><code><a href="https://github.com/r-lib/styler">library("styler")
library("dplyr")

code &lt;- "a &lt;- function(x) { if(x &gt; 1) { 1+1 } else {x} }"

(parse_table &lt;- styler:::compute_parse_data_flat_enhanced(code))

## # A tibble: 24 x 14
##    line1  col1 line2  col2          token     text terminal short newlines
##    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;          &lt;chr&gt;    &lt;chr&gt;    &lt;lgl&gt; &lt;chr&gt;    &lt;int&gt;
##  1     1     0     1     0          START                NA  &lt;NA&gt;        0
##  2     1     1     1     1         SYMBOL        a     TRUE     a        0
##  3     1     3     1     4    LEFT_ASSIGN       &lt;-     TRUE    &lt;-        0
##  4     1     6     1    13       FUNCTION function     TRUE funct        0
##  5     1    14     1    14            '('        (     TRUE     (        0
##  6     1    15     1    15 SYMBOL_FORMALS        x     TRUE     x        0
##  7     1    16     1    16            ')'        )     TRUE     )        0
##  8     1    18     1    18            '{'        {     TRUE     {        0
##  9     1    20     1    21             IF       if     TRUE    if        0
## 10     1    22     1    22            '('        (     TRUE     (        0
## # ... with 14 more rows, and 5 more variables: lag_newlines &lt;int&gt;,
## #   spaces &lt;int&gt;, multi_line &lt;lgl&gt;, indention_ref_id &lt;lgl&gt;, indent &lt;dbl&gt;</a></code></pre>
<p>The column <code>spaces</code> was computed from the columns <code>col1</code> and <code>col2</code>, <code>newlines</code> was computed from <code>line1</code> and <code>line2</code> respectively.</p>
<p>So far, styler can set the spaces around the operators correctly. In our example, that involves adding spaces around <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code>, so in the <code>spaces</code> column, element nine and ten must be set to one. This means that a space is added after <code>1</code> and after <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code>. To get the spacing right and cover the various cases, a set of functions has to be applied to the parse table subsequently (and in the right order), which is essentially done via <code><a href="https://rdrr.io/r/base/funprog.html">Reduce()</a></code>. After all modifications on the table are completed, <code>serialize_parse_data()</code> collapses the <code>text</code> column and adds the number of spaces and line breaks specified in <code>spaces</code> and <code>newlines</code> in between the elements of <code>text</code>. If we serialize our table and don’t perform any modification, we obviously just get back what we started with.</p>
<pre><code>styler:::serialize_parse_data_flat(parse_table)

## [1] "a &lt;- function(x) { if(x &gt; 1) { 1+1 } else {x} }"</code></pre>
</div>
<div id="refining-the-flat-approach---nesting-the-parse-table" class="section level2">
<h2 class="hasAnchor">
<a href="#refining-the-flat-approach---nesting-the-parse-table" class="anchor"></a>Refining the flat approach - nesting the parse table</h2>
<p>Although the flat approach is good place to start, e.g. for fixing spaces between operators, it has its limitations. In particular, it treats each token the same way in the sense that it does not account for the context of the token, i.e. in which sub-expression it appears. To set the indention correctly, we need a hierarchical view on the parse data, since all tokens in a sub-expression have the same indention level. Hence, a natural approach would be to create a nested parse table instead of a flat parse table and then take a recursion over all elements in the table, so for each sub(-sub etc.)-expression, a separate parse table would be created and the modifications would be applied to this table before putting everything back together. A function to create a nested parse table already exists in <code>styler</code>. Let’s have a look at the top level:</p>
<pre><code>(l1 &lt;- styler:::compute_parse_data_nested(code)[-1])

## # A tibble: 1 x 13
##    col1 line2  col2    id parent token terminal  text short token_before
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;chr&gt;    &lt;lgl&gt; &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;
## 1     1     1    47    49      0  expr    FALSE                     &lt;NA&gt;
## # ... with 3 more variables: token_after &lt;chr&gt;, internal &lt;lgl&gt;,
## #   child &lt;list&gt;</code></pre>
<p>The tibble contains the column <code>child</code>, which itself contains a tibble. If we “enter” the first child, we can see that the expression was split up further.</p>
<pre><code>l1$child[[1]] %&gt;%
  select(text, terminal, child, token)

## # A tibble: 3 x 4
##    text terminal             child       token
##   &lt;chr&gt;    &lt;lgl&gt;            &lt;list&gt;       &lt;chr&gt;
## 1          FALSE &lt;tibble [1 x 14]&gt;        expr
## 2    &lt;-     TRUE            &lt;NULL&gt; LEFT_ASSIGN
## 3          FALSE &lt;tibble [5 x 14]&gt;        expr</code></pre>
<p>And further…</p>
<pre><code>l1$child[[1]]$child[[3]]$child[[5]]

## # A tibble: 3 x 14
##   line1  col1 line2  col2    id parent token terminal  text short
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;chr&gt;    &lt;lgl&gt; &lt;chr&gt; &lt;chr&gt;
## 1     1    18     1    18     9     45   '{'     TRUE     {     {
## 2     1    20     1    45    42     45  expr    FALSE            
## 3     1    47     1    47    40     45   '}'     TRUE     }     }
## # ... with 4 more variables: token_before &lt;chr&gt;, token_after &lt;chr&gt;,
## #   internal &lt;lgl&gt;, child &lt;list&gt;</code></pre>
<p>… and so on. Every child that is not a terminal contains another tibble where the sub-expression is split up further - until we are left with tibbles that only contain terminals.</p>
<p>Recall the above example. <code>a &lt;- function(x) { if(x &gt; 1) { 1+1 } else {x} }</code>. In the last printed parse table, we can see that see that the whole if condition is a sub-expression of <code>code</code>, surrounded by two curly brackets. Hence, one would like to set the indention level for this sub-expression before doing anything with it in more detail. Later, when we progressed deeper into the nested table, we hit a similar pattern:</p>
<pre><code>l1$child[[1]]$child[[3]]$child[[5]]$child[[2]]$child[[5]]

## # A tibble: 3 x 14
##   line1  col1 line2  col2    id parent token terminal  text short
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;chr&gt;    &lt;lgl&gt; &lt;chr&gt; &lt;chr&gt;
## 1     1    30     1    30    20     30   '{'     TRUE     {     {
## 2     1    32     1    34    27     30  expr    FALSE            
## 3     1    36     1    36    26     30   '}'     TRUE     }     }
## # ... with 4 more variables: token_before &lt;chr&gt;, token_after &lt;chr&gt;,
## #   internal &lt;lgl&gt;, child &lt;list&gt;</code></pre>
<p>Again, we have two curly brackets and an expression inside. We would like to set the indention level for the expression <code>1+1</code> in the same way as for the whole if condition.</p>
<p>The simple example above makes it evident that a recursive approach to this problem would be the most natural.</p>
<p>The code for a function that kind of sketches the idea and illustrates such a recursion is given below.</p>
<p>It takes a nested parse table as input and then does the recursion over all children. If the child is a terminal, it returns the text, otherwise, it “enters” the child to find the terminals inside of the child and returns them.</p>
<pre><code>serialize &lt;- function(x) {
  out &lt;- Map(
    function(terminal, text, child) {
      if (terminal)
        text
      else
        serialize(child)
    },
    x$terminal, x$text, x$child
  )
  out
}

x &lt;- styler:::compute_parse_data_nested(code)
serialize(x) %&gt;% unlist

##  [1] "a"        "&lt;-"       "function" "("        "x"        ")"       
##  [7] "{"        "if"       "("        "x"        "&gt;"        "1"       
## [13] ")"        "{"        "1"        "+"        "1"        "}"       
## [19] "else"     "{"        "x"        "}"        "}"</code></pre>
<p>How to exactly implement a similar recursion to not just return each text token separately, but the styled text as one string (or one string per line) is subject to future work, so would be the functions to be applied to a sub-expression parse table that create correct indention. Similar to <code>compute_parse_data_flat_enhanced</code>, the column <code>spaces</code> and <code>newlines</code> would be required to be computed by <code>compute_parse_data_nested</code> as well as a new column <code>indention</code>.</p>
</div>
<div id="final-remarks" class="section level2">
<h2 class="hasAnchor">
<a href="#final-remarks" class="anchor"></a>Final Remarks</h2>
<p>Although a flat structure would possibly also allow us to solve the problem of indention, it is a less elegant and flexible solution to the problem. It would involve looking for an opening curly bracket in the parse table, set the indention level for all subsequent rows in the parse table until the next opening or closing curly bracket is hit and then intending one level further or setting indention back to where it was at the beginning of the table.</p>
<p>Note that the vignette just addressed the question of indention caused by curly brackets and has not dealt with other operators that would trigger indention, such as <code>(</code> or <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code>.</p>
<p>[1] at commit <code>e6ddee0f510d3c9e3e22ef68586068fa5c6bc140</code></p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>at commit <code>e6ddee0f510d3c9e3e22ef68586068fa5c6bc140</code><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://krlmlr.info">Kirill Müller</a>, <a href="https://lorenzwalthert.com">Lorenz Walthert</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '13580d327d8a7159f83a7cff178d2141',
    indexName: 'r-lib_styler',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
